<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>THEINFINITESELVES — XR Room 004 (The Threshold Lobby)</title>

  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <style>
    html, body { margin: 0; height: 100%; background: #000; overflow: hidden; }
    .hud {
      position: fixed; left: 14px; top: 12px; z-index: 10;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: rgba(255,255,255,.9);
      text-shadow: 0 1px 10px rgba(0,0,0,.6);
      pointer-events: none;
      max-width: 560px;
      line-height: 1.2;
    }
    .chip {
      display: inline-block;
      margin-top: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(120, 70, 255, .16);
      border: 1px solid rgba(160, 120, 255, .24);
      font-size: 12px;
      letter-spacing: .2px;
    }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; opacity: .9; }

    /* Audio unlock overlay (Quest Browser needs a real user gesture) */
    #audioGate {
      position: fixed; inset: 0; z-index: 9999;
      display: flex; align-items: center; justify-content: center;
      background: radial-gradient(1200px 800px at 50% 45%, rgba(179, 92, 255, .18), rgba(0,0,0,.86));
      color: rgba(255,255,255,.92);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      text-align: center;
      padding: 24px;
    }
    #audioGate .panel{
      max-width: 560px;
      border-radius: 18px;
      padding: 18px 18px 14px;
      background: rgba(10,6,18,.55);
      border: 1px solid rgba(180,120,255,.22);
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
    }
    #audioGate h1{
      font-size: 16px;
      letter-spacing: .35px;
      margin: 0 0 8px 0;
      color: rgba(255,255,255,.95);
    }
    #audioGate p{
      margin: 0 0 12px 0;
      font-size: 13px;
      opacity: .9;
      line-height: 1.35;
    }
    #audioBtn{
      appearance: none; border: 0;
      cursor: pointer;
      padding: 10px 14px;
      border-radius: 999px;
      background: rgba(179, 92, 255, .20);
      border: 1px solid rgba(200, 140, 255, .35);
      color: rgba(255,255,255,.95);
      font-weight: 600;
      letter-spacing: .25px;
    }
    #audioBtn:active{ transform: translateY(1px); }
    #tiny{
      margin-top: 10px;
      font-size: 12px;
      opacity: .75;
    }
  </style>

  <script>
    // Global room state used by locomotion + switcher
    window.__TIS_ROOM = 'void';

    AFRAME.registerComponent('starfield-spheres', {
  schema: {
    count: { type: 'int', default: 800 },
    radius: { type: 'number', default: 90 }
  },

  init: function () {
    this.stars = [];
    const root = this.el;
    const count = this.data.count;
    const R = this.data.radius;

    for (let i = 0; i < count; i++) {
      const theta = Math.random() * Math.PI * 2;
      const phi = Math.acos(2 * Math.random() - 1);
      const r = R * (0.3 + Math.random() * 0.7);

      const x = r * Math.sin(phi) * Math.cos(theta);
      const y = r * Math.cos(phi);
      const z = r * Math.sin(phi) * Math.sin(theta);

      const s = document.createElement('a-sphere');
      const size = 0.01 + Math.random() * 0.04;

      const pick = Math.random();
      let color = '#ffffff';
      if (pick < 0.6) color = '#ffffff';
      else if (pick < 0.8) color = '#d9ccff';
      else color = '#7b5cff';

      s.setAttribute('radius', size);
      s.setAttribute('position', `${x} ${y} ${z}`);
      s.setAttribute('material', `shader: standard; color:${color}; emissive:${color}; emissiveIntensity:${0.5 + Math.random()}`);

      root.appendChild(s);

      this.stars.push({
        el: s,
        base: new THREE.Vector3(x, y, z),
        speed: 0.2 + Math.random() * 0.8,
        twinkle: 0.3 + Math.random() * 1.5,
        phase: Math.random() * Math.PI * 2
      });
    }
  },

  tick: function (time) {

  // time comes in as milliseconds already — convert once
  const t = time * 0.001;

  for (let s of this.stars) {

    // slow independent twinkle only
    const glow = 0.7 + Math.sin(t * s.twinkle * 0.4 + s.phase) * 0.3;
    s.el.setAttribute('material', 'emissiveIntensity', glow);

    // HARD lock position — no drift, no orbit, no wobble
    s.el.object3D.position.set(
      s.base.x,
      s.base.y,
      s.base.z
    );
  }
}
      });




    // FPS locomotion (Quest sticks) + optional room bounds clamp when in lobby
    AFRAME.registerComponent('xr-fps-locomotion', {
      schema: {
        moveSpeed: {type: 'number', default: 2.4},
        turnSpeed: {type: 'number', default: 160},
        deadzone: {type: 'number', default: 0.18}
      },
      init: function () {
        this.tmpDir = new THREE.Vector3();
        this.tmpForward = new THREE.Vector3();
        this.tmpRight = new THREE.Vector3();
        this.tmpUp = new THREE.Vector3(0,1,0);
      },
      tick: function (t, dt) {
        dt = (dt || 0) / 1000;
        if (!dt) return;

        const rig = this.el;
        const scene = rig.sceneEl;
        const xr = scene && scene.renderer && scene.renderer.xr;
        const inXR = xr && xr.isPresenting;
        if (!inXR) return;

        const session = xr.getSession && xr.getSession();
        if (!session) return;

        let left = null, right = null;
        const sources = session.inputSources || [];
        for (const s of sources) {
          if (!s || !s.gamepad) continue;
          if (s.handedness === 'left') left = s.gamepad;
          if (s.handedness === 'right') right = s.gamepad;
        }

        // Smooth turn (right stick X)
        if (right && right.axes && right.axes.length >= 2) {
          const turnX = (right.axes.length >= 3) ? right.axes[2] : right.axes[0];
          if (Math.abs(turnX) > this.data.deadzone) {
            const rot = rig.getAttribute('rotation') || {x:0,y:0,z:0};
            rot.y -= turnX * this.data.turnSpeed * dt;
            rig.setAttribute('rotation', rot);
          }
        }

        // Move (left stick) - X strafe, Y forward/back
        if (left && left.axes && left.axes.length >= 2) {
          let rawX = (left.axes.length >= 4) ? left.axes[2] : left.axes[0];
          let rawY = (left.axes.length >= 4) ? left.axes[3] : left.axes[1];

          // Quest 3S quirks vary; keep the successful mapping you already confirmed
          const x = -rawX;
          const y = -rawY;

          const ax = Math.abs(x) > this.data.deadzone ? x : 0;
          const ay = Math.abs(y) > this.data.deadzone ? y : 0;
          if (ax === 0 && ay === 0) return;

          const cam = document.getElementById('cam');
          const camObj = (cam && cam.object3D) ? cam.object3D : rig.object3D;

          camObj.getWorldDirection(this.tmpForward);
          this.tmpForward.y = 0;
          this.tmpForward.normalize();

          this.tmpRight.copy(this.tmpForward).cross(this.tmpUp).normalize();

          this.tmpDir.set(0,0,0);
          this.tmpDir.addScaledVector(this.tmpForward, -ay);
          this.tmpDir.addScaledVector(this.tmpRight, ax);

          const len = this.tmpDir.length();
          if (len > 1e-6) {
            this.tmpDir.normalize();
            rig.object3D.position.addScaledVector(this.tmpDir, this.data.moveSpeed * dt);
          }
        }

        // Keep height stable (prevents "sinking" feelings across modes)
        rig.object3D.position.y = 1.6;

        // Simple lobby bounds clamp (no physics engine needed yet)
        if (window.__TIS_ROOM === 'lobby') {
          const p = rig.object3D.position;
          // Lobby is centered around z = -34, width ~18, depth ~18
          p.x = Math.min(8.5, Math.max(-8.5, p.x));
          p.z = Math.min(-25.5, Math.max(-42.5, p.z));
        }
      }
    });

    // Room switching by walking into a trigger volume
    AFRAME.registerComponent('room-switcher', {
      init: function () {
        this.rig = document.getElementById('rig');
        this.voidRoot = document.getElementById('roomVoid');
        this.lobbyRoot = document.getElementById('roomLobby');
        this.hudTitle = document.getElementById('hudTitle');
        this.last = window.__TIS_ROOM || 'void';
      },
      tick: function () {
        if (!this.rig || !this.voidRoot || !this.lobbyRoot) return;
        const p = this.rig.object3D.position;

        // Enter lobby if you walk forward past the threshold plane
        if (window.__TIS_ROOM === 'void' && p.z < -12.0) {
          window.__TIS_ROOM = 'lobby';
          this.voidRoot.setAttribute('visible', 'false');
          this.lobbyRoot.setAttribute('visible', 'true');

          // Teleport rig to lobby spawn point
          this.rig.object3D.position.set(0, 1.6, -34);
          this.rig.setAttribute('rotation', {x:0, y:0, z:0});

          if (this.hudTitle) this.hudTitle.textContent = 'THEINFINITESELVES — Room 004: The Threshold Lobby';
        }

        // Exit lobby if you walk back toward the entrance (front edge)
        if (window.__TIS_ROOM === 'lobby' && p.z > -26.2) {
          window.__TIS_ROOM = 'void';
          this.voidRoot.setAttribute('visible', 'true');
          this.lobbyRoot.setAttribute('visible', 'false');

          // Teleport back into void near spawn confirms
          this.rig.object3D.position.set(0, 1.6, 2);
          this.rig.setAttribute('rotation', {x:0, y:0, z:0});

          if (this.hudTitle) this.hudTitle.textContent = 'THEINFINITESELVES — Room 004: The Void (Threshold Active)';
        }
      }
    });

    // Audio unlock helper (Quest Browser needs an explicit click on the page)
    function __tisUnlockAudio(){
      const ctx = AFRAME.audioContext;
      if (ctx && ctx.state !== 'running') ctx.resume();
      const scene = document.querySelector('a-scene');
      if (!scene) return;
      const sounds = scene.querySelectorAll('a-sound');
      sounds.forEach(s => {
        if (s.components && s.components.sound) {
          try { s.components.sound.playSound(); } catch(e) {}
        }
      });
    }

    window.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById('audioBtn');
      const gate = document.getElementById('audioGate');
      if (!btn || !gate) return;

      btn.addEventListener('click', () => {
        __tisUnlockAudio();
        gate.style.display = 'none';
      }, {passive:true});
    });
  </script>
</head>

<body>
  <div id="audioGate">
    <div class="panel">
      <h1>THEINFINITESELVES</h1>
      <p>Tap once to unlock audio in Quest Browser. After that, enter VR. (This is a WebXR browser rule.)</p>
      <button id="audioBtn">Unlock Audio</button>
      <div id="tiny">If you still hear nothing: host the audio file inside this same Netlify folder and set src="audio.mp3".</div>
    </div>
  </div>

  <div class="hud">
    <div id="hudTitle" style="font-size:14px; letter-spacing:.25px; opacity:.95;">THEINFINITESELVES — Room 004: The Threshold Lobby</div>
    <div class="chip">
      <span class="kbd">Desktop:</span> WASD + Mouse look &nbsp;|&nbsp;
      <span class="kbd">XR:</span> Left stick move + Right stick smooth turn
      <span style="opacity:.75;">&nbsp;|&nbsp; Walk forward to cross the Threshold</span>
    </div>
  </div>

  <a-scene
    room-switcher
    background="color: #030007"
    renderer="antialias: true; colorManagement: true; physicallyCorrectLights: true"
    vr-mode-ui="enabled: true"
    fog="type: exponential; color: #2a0b4f; density: 0.032"
  >

    <!-- ROOM 1: THE VOID (visible at start) -->
    <a-entity id="roomVoid" visible="true">
      <a-entity light="type: ambient; intensity: 0.35; color: #9d6cff"></a-entity>
      <a-entity light="type: point; intensity: 1.3; color: #ff7aff; distance: 90" position="-12 14 -20"></a-entity>
      <a-entity light="type: point; intensity: 1.1; color: #6a6bff; distance: 90" position="12 10 8"></a-entity>
      <a-entity light="type: point; intensity: 0.7; color: #3b0a8f; distance: 120" position="0 -10 0"></a-entity>

      <a-entity id="stars" starfield-spheres="count: 700; radius: 140"></a-entity>

      <a-entity id="dust" animation="property: rotation; to: 0 360 0; dur: 120000; easing: linear; loop: true">
        <a-entity starfield-spheres="count: 420; radius: 34"></a-entity>
      </a-entity>

      <a-sky color="#04000a"></a-sky>

      <!-- Brand marker inside the void -->
      <a-entity id="brand" position="0 2.2 -6">
        <a-text value="THEINFINITESELVES"
          align="center"
          width="12"
          color="#ffffff"
          shader="msdf"
          opacity="1"
          material="emissive:#b35cff; emissiveIntensity:2.5"
        ></a-text>

        <a-text value="THE VOID" position="0 -0.55 0" align="center" width="10" color="#b7a5ff" opacity="0.85"></a-text>

        <a-entity animation="property: position; dir: alternate; dur: 2400; easing: easeInOutSine; loop: true; to: 0 2.55 -6"></a-entity>

        <a-ring position="0 -0.95 0" radius-inner="0.9" radius-outer="1.25" rotation="90 0 0"
          material="shader: standard; color: #0b0617; emissive: #7b5cff; emissiveIntensity: 0.9; opacity: 0.75; transparent: true"></a-ring>
      </a-entity>

      <!-- Threshold marker (walk forward past z=-12 to enter the Lobby) -->
      <a-entity position="0 1.2 -12">
        <a-ring radius-inner="0.55" radius-outer="0.85" rotation="90 0 0"
          material="shader: standard; color: #080311; emissive: #b35cff; emissiveIntensity: 0.65; opacity: 0.55; transparent: true"></a-ring>
        <a-text value="THRESHOLD" position="0 0.75 0" align="center" width="6" color="#d9ccff" opacity="0.8"></a-text>
      </a-entity>
    </a-entity>

    <!-- ROOM 2: THE THRESHOLD LOBBY (hidden until you cross) -->
    <a-entity id="roomLobby" visible="false">

      <!-- Lobby lighting -->
      <a-entity light="type: ambient; intensity: 0.55; color: #b79cff"></a-entity>
      <a-entity light="type: point; intensity: 1.25; color: #6a6bff; distance: 45" position="-6 6 -36"></a-entity>
      <a-entity light="type: point; intensity: 1.15; color: #ff7aff; distance: 45" position="6 6 -36"></a-entity>
      <a-entity light="type: point; intensity: 0.65; color: #3b0a8f; distance: 70" position="0 2 -44"></a-entity>

      <!-- The lobby shell (simple, clean, intentional geometry) -->
      <a-entity id="lobbyShell" position="0 0 0">
        <!-- floor -->
        <a-plane position="0 0 -34" rotation="-90 0 0" width="18" height="18"
          material="shader: standard; color: #07030f; roughness: 0.95; metalness: 0.05; emissive: #1a0a2e; emissiveIntensity: 0.28"></a-plane>

        <!-- ceiling -->
        <a-plane position="0 7.2 -34" rotation="90 0 0" width="18" height="18"
          material="shader: standard; color: #05020b; roughness: 1; metalness: 0; emissive: #2a0b4f; emissiveIntensity: 0.12; opacity: 0.92; transparent: true"></a-plane>

        <!-- back wall -->
        <a-plane position="0 3.6 -43" rotation="0 0 0" width="18" height="7.2"
          material="shader: standard; color: #05020b; roughness: 1; metalness: 0; emissive: #2a0b4f; emissiveIntensity: 0.12"></a-plane>

        <!-- left wall -->
        <a-plane position="-9 3.6 -34" rotation="0 90 0" width="18" height="7.2"
          material="shader: standard; color: #05020b; roughness: 1; metalness: 0; emissive: #2a0b4f; emissiveIntensity: 0.12"></a-plane>

        <!-- right wall -->
        <a-plane position="9 3.6 -34" rotation="0 -90 0" width="18" height="7.2"
          material="shader: standard; color: #05020b; roughness: 1; metalness: 0; emissive: #2a0b4f; emissiveIntensity: 0.12"></a-plane>

        <!-- entrance frame (open front, like an arrival bay) -->
        <a-entity position="0 0 -25.8">
          <a-ring radius-inner="3.0" radius-outer="3.4" rotation="0 0 0" position="0 3.6 0"
            material="shader: standard; color: #080311; emissive: #b35cff; emissiveIntensity: 0.55; opacity: 0.55; transparent: true"></a-ring>
          <a-text value="THE THRESHOLD" position="0 6.15 0.05" align="center" width="10" color="#ffffff"
            material="emissive:#b35cff; emissiveIntensity:2.0"></a-text>
          <a-text value="Arrive. Breathe. Choose." position="0 5.45 0.05" align="center" width="10" color="#d9ccff" opacity="0.85"></a-text>
          <a-text value="Walk back through the ring to return to the Void." position="0 0.6 0.05" align="center" width="12" color="#b7a5ff" opacity="0.65"></a-text>
        </a-entity>

        <!-- subtle “nebula bleed” panels (fake volumetric vibe via translucent layers) -->
        <a-plane position="0 3.6 -42.95" width="17.4" height="6.8"
          material="shader: standard; color: #1b0634; emissive: #ff7aff; emissiveIntensity: 0.06; opacity: 0.12; transparent: true"></a-plane>

        <a-plane position="0 3.6 -42.85" width="16.2" height="6.0"
          material="shader: standard; color: #0a1640; emissive: #6a6bff; emissiveIntensity: 0.06; opacity: 0.10; transparent: true"></a-plane>

        <!-- Central “decision plinth” (where future links/rooms will live) -->
        <a-cylinder position="0 0.45 -34" radius="1.05" height="0.9"
          material="shader: standard; color: #07030f; emissive: #2a0b4f; emissiveIntensity: 0.35; roughness: 0.9; metalness: 0.08"></a-cylinder>

        <a-ring position="0 0.92 -34" rotation="-90 0 0" radius-inner="1.15" radius-outer="1.55"
          material="shader: standard; color: #07030f; emissive: #b35cff; emissiveIntensity: 0.75; opacity: 0.55; transparent: true"></a-ring>

        <a-text value="DESTINATIONS" position="0 2.2 -34" align="center" width="10" color="#ffffff"
          material="emissive:#b35cff; emissiveIntensity:1.8"></a-text>
        <a-text value="(Coming Next)" position="0 1.55 -34" align="center" width="8" color="#d9ccff" opacity="0.78"></a-text>

        <!-- Lobby stardust (very light) -->
        <a-entity position="0 3.6 -34" animation="property: rotation; to: 0 -360 0; dur: 160000; easing: linear; loop: true">
          <a-entity starfield-spheres="count: 180; radius: 9"></a-entity>
        </a-entity>

        <!-- Audio anchor: best practice is hosting audio inside your Netlify folder -->
        <!-- Put a file named audio.mp3 in this same folder and it will work as: src="audio.mp3" -->
        <a-entity position="0 2.2 -34">
          <a-sound
            src="countdowndrillrec.mp3"
            autoplay="true"
            loop="true"
            positional="true"
            volume="0.9"
            distance-model="inverse"
            ref-distance="3"
            max-distance="35">
          </a-sound>
        </a-entity>

      </a-entity>
    </a-entity>

    <!-- Player rig -->
    <a-entity id="rig" position="0 1.6 2" rotation="0 0 0" xr-fps-locomotion="moveSpeed: 2.6; turnSpeed: 160; deadzone: 0.18">
      <a-entity id="cam" camera look-controls="pointerLockEnabled: true" wasd-controls="acceleration: 55" position="0 0 0"></a-entity>
      <a-entity laser-controls="hand: left"></a-entity>
      <a-entity laser-controls="hand: right"></a-entity>
    </a-entity>

  </a-scene>
</body>
</html>

